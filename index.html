<html>
<head>
<script>
// 从仓库的API地址获取文件列表，并过滤出符合扩展名的文件的URL和文件名，返回一个对象数组
async function getFiles(repoAPI) {
  let data = await fetch(repoAPI).then(res => res.json());
  return data.filter(item => item.type == "file" && extensions.includes(item.name.slice(-4)))
             .map(item => ({url: item.download_url, name: item.name}));
}

// 从数组中随机打乱元素的顺序，并返回一个新数组
function shuffleArray(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

// 从数组中选择一个元素并返回，同时从数组中删除该元素
function popChoice(arr) {
  return arr.splice(Math.floor(Math.random() * arr.length), 1)[0];
}

// 从文件列表中生成一个随机顺序的URL数组，同时避免相似文件名的文件在顺序中连续
function getRandomOrder(files) {
  let order = [];
  let candidates = shuffleArray(files);
  while (candidates.length > 0) {
    let file = popChoice(candidates);
    order.push(file.url);
    let similar = candidates.filter(f => f.name.slice(0, -4) == file.name.slice(0, -4));
    candidates = candidates.filter(f => f.name.slice(0, -4) != file.name.slice(0, -4));
    candidates.push(...similar);
  }
  return order;
}

// 从本地存储中获取当前的URL顺序和索引，如果不存在则从文件列表中生成一个新的顺序和索引
function getOrderAndIndex(files) {
  let order = localStorage.getItem("order");
  let index = localStorage.getItem("index");
  if (order == null || index == null) {
    order = getRandomOrder(files);
    index = 0;
  } else {
    order = JSON.parse(order);
    index = parseInt(index);
  }
  return {order, index};
}

// 将当前的URL顺序和索引保存到本地存储中
function saveOrderAndIndex(order, index) {
  localStorage.setItem("order", JSON.stringify(order));
  localStorage.setItem("index", index.toString());
}

// 从当前的URL顺序中获取下一个URL，并更新索引，如果顺序已经用完，则从文件列表中生成一个新的顺序
async function getNextUrl(files) {
  let {order, index} = getOrderAndIndex(files);
  let url = order[index];
  index++;
  if (index >= order.length) {
    order = getRandomOrder(files);
    index = 0;
  }
  saveOrderAndIndex(order, index);
  return url;
}

// 重定向到一个按顺序的文件的URL，并在页面上显示要重定向的URL文本
async function redirectToFile() {
  try {
    let files = await getFiles(repoAPI);
    let file = await getNextUrl(files);
    document.getElementById("url").textContent = file;
    setTimeout(() => window.location.href = file, delay);
  } catch (error) {
    console.error(error);
  }
}

// 这些变量可以根据你的需要修改
var repoAPI = "https://api.github.com/repos/jkamkk/mp3/contents/"; // 你的仓库的API地址
var extensions = [".mp4", ".m4a", ".wav", ".mp3"]; // 你想要获取的文件的扩展名
var delay = 3000; // 重定向的延迟时间，单位是毫秒
</script>
</head>
<body onload="redirectToFile()">
<div id="url" style="font-family: monospace; font-size: 24px; text-align: center;"></div>
</body>
</html>
