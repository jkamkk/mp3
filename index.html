<html>
<head>
<script>
// 这个变量存放了你的仓库的API地址，你可以根据你的仓库名和用户名修改
var repoAPI = "https://api.github.com/repos/jkamkk/mp3/contents/";

// 这个变量存放了你想要获取的文件的扩展名，你可以根据你的需要添加或删除
var extensions = [".mp3", ".mp4", ".m4a", ".wav"];

// 这个函数用来从一个URL获取JSON数据，并返回一个Promise对象
function getJSON(url) {
  return new Promise(function(resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.responseType = "json";
    xhr.onload = function() {
      if (xhr.status == 200) {
        resolve(xhr.response);
      } else {
        reject(new Error(xhr.statusText));
      }
    };
    xhr.onerror = function() {
      reject(new Error(xhr.statusText));
    };
    xhr.send();
  });
}

// 这个函数用来从仓库的API地址获取文件列表，并过滤出符合扩展名的文件的URL和名称，返回一个对象数组
function getFiles(repoAPI) {
  return getJSON(repoAPI).then(function(data) {
    var files = [];
    for (var i = 0; i < data.length; i++) {
      var item = data[i];
      if (item.type == "file" && extensions.includes(item.name.slice(-4))) {
        files.push({url: item.download_url, name: item.name});
      }
    }
    return files;
  });
}

// 这个函数用来从数组中随机选择一个元素并返回
function randomChoice(arr) {
  var index = Math.floor(Math.random() * arr.length);
  return arr[index];
}

// 这个函数用来从数组中随机打乱元素的顺序，并返回一个新数组
function shuffleArray(arr) {
  var newArr = arr.slice();
  for (var i = newArr.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = newArr[i];
    newArr[i] = newArr[j];
    newArr[j] = temp;
  }
  return newArr;
}

// 这个函数用来检查一个文件名是否和另一个文件名相似，相似的条件是除了扩展名外，其他部分有超过一半的字符相同，返回一个布尔值
function isSimilar(name1, name2) {
  var base1 = name1.slice(0, -4);
  var base2 = name2.slice(0, -4);
  var len = Math.min(base1.length, base2.length);
  var count = 0;
  for (var i = 0; i < len; i++) {
    if (base1[i] == base2[i]) {
      count++;
    }
  }
  return count > len / 2;
}

// 这个函数用来从文件列表中生成一个随机的顺序列表，要求相似文件名的文件不能在顺序中连续，返回一个URL数组
function getRandomOrder(files) {
  var order = [];
  var shuffled = shuffleArray(files);
  var last = null;
  while (shuffled.length > 0) {
    var file = randomChoice(shuffled);
    if (last == null || !isSimilar(file.name, last.name)) {
      order.push(file.url);
      shuffled.splice(shuffled.indexOf(file), 1);
      last = file;
    }
  }
  return order;
}

// 这个函数用来从本地存储中获取当前的顺序列表和索引，如果不存在则从文件列表中生成一个新的顺序列表和索引，返回一个对象
function getOrderAndIndex() {
  var order = localStorage.getItem("order");
  var index = localStorage.getItem("index");
  if (order == null || index == null) {
    getFiles(repoAPI).then(function(files) {
      order = getRandomOrder(files);
      index = 0;
      localStorage.setItem("order", JSON.stringify(order));
      localStorage.setItem("index", index);
      return {order: order, index: index};
    }).catch(function(error) {
      console.error(error);
    });
  } else {
    order = JSON.parse(order);
    index = parseInt(index);
    return {order: order, index: index};
  }
}

// 这个函数用来重定向到一个按照顺序列表的文件的URL，并更新本地存储中的索引，如果顺序列表已经用完，则生成一个新的顺序列表和索引
function redirectToFile() {
  var orderAndIndex = getOrderAndIndex();
  var order = orderAndIndex.order;
  var index = orderAndIndex.index;
  var file = order[index];
  window.location.href = file;
  index++;
  if (index >= order.length) {
    localStorage.removeItem("order");
    localStorage.removeItem("index");
  } else {
    localStorage.setItem("index", index);
  }
}

// 这个函数用来在页面上显示要重定向的文件的URL
function showFile() {
  var orderAndIndex = getOrderAndIndex();
  var order = orderAndIndex.order;
  var index = orderAndIndex.index;
  var file = order[index];
  document.getElementById("file").innerText = file;
}
</script>
</head>
<body onload="showFile()">
<div id="file"></div>
</body>
</html>
